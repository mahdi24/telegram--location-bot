import smtplib
from email.mime.text import MIMEText
from telegram import KeyboardButton, ReplyKeyboardMarkup, Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
BOT_TOKEN = "8420831695:AAH5p-3iyYeb_IU7wCzobmBbXF4-9XsmprI"
EMAIL_USER = "Ø§ÛŒÙ…ÛŒÙ„_ÙØ±Ø³ØªÙ†Ø¯Ù‡@gmail.com"  # Ø¬ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯Øª Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„
EMAIL_PASS = "AppPassword"               # Ù¾Ø³ÙˆØ±Ø¯ Ø§Ù¾ Ù…Ø®ØµÙˆØµ Ø¬ÛŒÙ…ÛŒÙ„
EMAIL_TO   = "press.itengineering@gmail.com"  # Ø§ÛŒÙ…ÛŒÙ„ Ù…Ù‚ØµØ¯

# --- ØªØ§Ø¨Ø¹ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ ---
def send_email(subject, body):
    msg = MIMEText(body)
    msg["Subject"] = subject
    msg["From"] = EMAIL_USER
    msg["To"] = EMAIL_TO
    with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
        server.login(EMAIL_USER, EMAIL_PASS)
        server.sendmail(EMAIL_USER, EMAIL_TO, msg.as_string())

# --- Ø§Ø³ØªØ§Ø±Øª ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    button = KeyboardButton("ğŸ“ Ø§Ø±Ø³Ø§Ù„ Ù„ÙˆÚ©ÛŒØ´Ù†", request_location=True)
    reply_markup = ReplyKeyboardMarkup([[button]], resize_keyboard=True, one_time_keyboard=True)
    await update.message.reply_text(
        "Ø³Ù„Ø§Ù…! Ù„Ø·ÙØ§Ù‹ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø²Ù† Ùˆ Ù„ÙˆÚ©ÛŒØ´Ù† Ø®ÙˆØ¯Øª Ø±Ùˆ Ø¨ÙØ±Ø³Øª:", 
        reply_markup=reply_markup
    )

# --- Ø¯Ø±ÛŒØ§ÙØª Ù„ÙˆÚ©ÛŒØ´Ù† ---
async def location_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    loc = update.message.location
    lat, lon = loc.latitude, loc.longitude
    gmap_link = f"https://www.google.com/maps?q={lat},{lon}"
    text = (
        f"ğŸ“ Ú©Ø§Ø±Ø¨Ø± {update.message.from_user.first_name} Ù„ÙˆÚ©ÛŒØ´Ù† ÙØ±Ø³ØªØ§Ø¯:\n\n"
        f"Latitude: {lat}\nLongitude: {lon}\n\n"
        f"ğŸ”— Ù„ÛŒÙ†Ú© Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡:\n{gmap_link}"
    )
    send_email("Ù„ÙˆÚ©ÛŒØ´Ù† Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…", text)
    await update.message.reply_text("âœ… Ù„ÙˆÚ©ÛŒØ´Ù† Ø´Ù…Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ Ùˆ Ø¨Ù‡ Ø§ÛŒÙ…ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")

# --- Ø±Ø§Ù† Ø±Ø¨Ø§Øª ---
def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.LOCATION, location_handler))
    app.run_polling()

if __name__ == "__main__":
    main()
